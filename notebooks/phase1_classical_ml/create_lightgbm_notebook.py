#!/usr/bin/env python3
"""
–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –Ω–æ—É—Ç–±—É–∫–∞ –¥–ª—è LightGBM Deep Dive
"""

import json

# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–æ—É—Ç–±—É–∫–∞
notebook = {
    "cells": [],
    "metadata": {
        "kernelspec": {
            "display_name": "Python 3",
            "language": "python",
            "name": "python3"
        },
        "language_info": {
            "name": "python",
            "version": "3.8.0"
        }
    },
    "nbformat": 4,
    "nbformat_minor": 4
}

cells = []

# ============================================================================
# TITLE & INTRO
# ============================================================================

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "# LightGBM Deep Dive: –û—Ç —Ç–µ–æ—Ä–∏–∏ –∫ –ø—Ä–∞–∫—Ç–∏–∫–µ\n",
        "\n",
        "## üéØ –¶–µ–ª–∏ –Ω–æ—É—Ç–±—É–∫–∞\n",
        "\n",
        "1. **–ì–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ** –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ LightGBM –∏ –∏—Ö –æ—Ç–ª–∏—á–∏–π –æ—Ç XGBoost\n",
        "2. **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ** –Ω–∞ –∑–∞–¥–∞—á–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –æ—Ç—Ç–æ–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ (churn)\n",
        "3. **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑** –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π: GOSS, EFB, histogram-based learning\n",
        "4. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ** —Å XGBoost –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤—É\n",
        "\n",
        "## üíº –ë–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞: Churn Prediction –≤ —Ç–µ–ª–µ–∫–æ–º–µ\n",
        "\n",
        "**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –¢–µ–ª–µ–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è —Ç–µ—Ä—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ (churn). –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å, –∫—Ç–æ –∏–∑ –∫–ª–∏–µ–Ω—Ç–æ–≤ —É–π–¥–µ—Ç –∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\n",
        "\n",
        "**–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:**\n",
        "- üí∞ **–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è** –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –≤ 5-25 —Ä–∞–∑ –≤—ã—à–µ, —á–µ–º —É–¥–µ—Ä–∂–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ\n",
        "- üìâ **Lifetime Value:** –ü–æ—Ç–µ—Ä—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ = –ø–æ—Ç–µ—Ä—è –±—É–¥—É—â–µ–π –ø—Ä–∏–±—ã–ª–∏\n",
        "- üéØ **Retention campaigns:** –¶–µ–ª–µ–≤—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —É–¥–µ—Ä–∂–∞–Ω–∏—è –¥–ª—è —Ä–∏—Å–∫–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n",
        "- üìä **–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** –°–Ω–∏–∂–µ–Ω–∏–µ churn rate = —Ä–æ—Å—Ç –¥–æ–ª–∏ —Ä—ã–Ω–∫–∞\n",
        "\n",
        "**–ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞:**\n",
        "- **Precision:** –ò–∑ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã—Ö \"—É–π–¥–µ—Ç\", —Å–∫–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —É–π–¥—É—Ç (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å retention –∫–∞–º–ø–∞–Ω–∏–π)\n",
        "- **Recall:** –ò–∑ —Ä–µ–∞–ª—å–Ω–æ —É—à–µ–¥—à–∏—Ö, —Å–∫–æ–ª—å–∫–æ –º—ã –ø–æ–π–º–∞–ª–∏ (–º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —É–ø—É—â–µ–Ω–Ω–æ–π –≤—ã–≥–æ–¥—ã)\n",
        "- **ROC-AUC:** –û–±—â–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è\n",
        "- **F1-score:** –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É precision –∏ recall\n",
        "\n",
        "**–°—Ç–æ–∏–º–æ—Å—Ç—å –æ—à–∏–±–æ–∫:**\n",
        "- **False Negative (–ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ churn):** –ü–æ—Ç–µ—Ä—è –∫–ª–∏–µ–Ω—Ç–∞ = —É–ø—É—â–µ–Ω–Ω–∞—è –ø—Ä–∏–±—ã–ª—å (~$500-5000)\n",
        "- **False Positive (–ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ retention —Ç–µ–º, –∫—Ç–æ –Ω–µ —Å–æ–±–∏—Ä–∞–ª—Å—è —É—Ö–æ–¥–∏—Ç—å):** –°—Ç–æ–∏–º–æ—Å—Ç—å –∫–∞–º–ø–∞–Ω–∏–∏ (~$50-100)\n",
        "- –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ: FN –≤ 10-50 —Ä–∞–∑ –¥–æ—Ä–æ–∂–µ FP\n",
        "\n",
        "---"
    ]
})

# ============================================================================
# THEORY PART 1: LightGBM Overview
# ============================================================================

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "## üìö –ß–∞—Å—Ç—å 1: –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç\n",
        "\n",
        "### 1.1 –ú–æ—Ç–∏–≤–∞—Ü–∏—è: –ü–æ—á–µ–º—É LightGBM?\n",
        "\n",
        "**–ü—Ä–æ–±–ª–µ–º—ã —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ GBDT (–≤–∫–ª—é—á–∞—è XGBoost):**\n",
        "\n",
        "1. **–°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è**\n",
        "   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ split –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–±—Ä–∞—Ç—å –≤—Å–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –∏ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø–æ—Ä–æ–≥–∏\n",
        "   - –°–ª–æ–∂–Ω–æ—Å—Ç—å: $O(\\text{features} \\times \\text{samples} \\times \\text{trees})$\n",
        "   - –î–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö (>10M –ø—Ä–∏–º–µ—Ä–æ–≤) –æ–±—É—á–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å —á–∞—Å—ã\n",
        "\n",
        "2. **–ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏**\n",
        "   - –•—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤ –∏ hessians –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞\n",
        "   - Pre-sorted –∞–ª–≥–æ—Ä–∏—Ç–º —Ç—Ä–µ–±—É–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π\n",
        "\n",
        "3. **–¢–æ—á–Ω–æ—Å—Ç—å –Ω–∞ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö**\n",
        "   - Level-wise —Ä–æ—Å—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º\n",
        "   - –î–µ—Ä–µ–≤—å—è —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏\n",
        "\n",
        "**–†–µ—à–µ–Ω–∏—è LightGBM (Microsoft Research, 2017):**\n",
        "\n",
        "| –ü—Ä–æ–±–ª–µ–º–∞ | –†–µ—à–µ–Ω–∏–µ | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |\n",
        "|----------|---------|----------|\n",
        "| –ü–µ—Ä–µ–±–æ—Ä –ø–æ—Ä–æ–≥–æ–≤ | **Histogram-based** –∞–ª–≥–æ—Ä–∏—Ç–º | 10-20x |\n",
        "| –ú–Ω–æ–≥–æ –º–∞–ª–æ–∑–Ω–∞—á–∏–º—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤ | **GOSS** (Gradient-based One-Side Sampling) | 2-5x |\n",
        "| –ú–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ | **EFB** (Exclusive Feature Bundling) | 2-3x |\n",
        "| –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Ä–æ—Å—Ç | **Leaf-wise** (best-first) —Ä–æ—Å—Ç | –õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ |\n",
        "| –ö–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ | **Native support** (optimal split) | –ù–µ –Ω—É–∂–µ–Ω one-hot |\n",
        "\n",
        "**–ò—Ç–æ–≥–æ:** LightGBM –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ **10-100x –±—ã—Å—Ç—Ä–µ–µ** XGBoost –Ω–∞ –±–æ–ª—å—à–∏—Ö –¥–∞—Ç–∞—Å–µ—Ç–∞—Ö —Å —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º!\n",
        "\n",
        "---"
    ]
})

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "### 1.2 –ö–ª—é—á–µ–≤–∞—è –∏–Ω–Ω–æ–≤–∞—Ü–∏—è #1: Histogram-Based Learning\n",
        "\n",
        "#### –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (pre-sorted)\n",
        "\n",
        "**XGBoost (exact algorithm):**\n",
        "1. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–∑–Ω–∞–∫–∞ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è\n",
        "2. –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –í–°–ï —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø–æ—Ä–æ–≥–∏\n",
        "3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Ä–æ–≥–∞ –≤—ã—á–∏—Å–ª—è–µ–º gain\n",
        "\n",
        "**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** $O(\\text{\\#features} \\times \\text{\\#samples} \\times \\log(\\text{\\#samples}))$ - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–æ—Ä–æ–≥–∞—è!\n",
        "\n",
        "#### LightGBM: Histogram-based –∞–ª–≥–æ—Ä–∏—Ç–º\n",
        "\n",
        "**–ò–¥–µ—è:** –í–º–µ—Å—Ç–æ –ø–µ—Ä–µ–±–æ—Ä–∞ –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π, —Ä–∞–∑–±–∏–≤–∞–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏ –Ω–∞ –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ bins (–≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã).\n",
        "\n",
        "**–ê–ª–≥–æ—Ä–∏—Ç–º:**\n",
        "\n",
        "1. **–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º** (–æ–¥–∏–Ω —Ä–∞–∑ –≤ –Ω–∞—á–∞–ª–µ):\n",
        "   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–∑–Ω–∞–∫–∞ –Ω–∞—Ö–æ–¥–∏–º –∫–≤–∞–Ω—Ç–∏–ª–∏ (–æ–±—ã—á–Ω–æ 255 bins)\n",
        "   - –ö–∞–∂–¥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∞ ‚Üí bin index\n",
        "   - –°–æ—Ö—Ä–∞–Ω—è–µ–º mapping: continuous value ‚Üí discrete bin\n",
        "\n",
        "2. **–ü–æ–∏—Å–∫ split:**\n",
        "   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ bin (–∞ –Ω–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è!) –≤—ã—á–∏—Å–ª—è–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã\n",
        "   - –°–æ–∑–¥–∞–µ–º –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ bin —Ö—Ä–∞–Ω–∏–º $(G_k, H_k, n_k)$\n",
        "     - $G_k = \\sum_{i \\in \\text{bin}_k} g_i$ - —Å—É–º–º–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤\n",
        "     - $H_k = \\sum_{i \\in \\text{bin}_k} h_i$ - —Å—É–º–º–∞ hessians\n",
        "     - $n_k$ - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–º–µ—Ä–æ–≤ –≤ bin\n",
        "\n",
        "3. **–í—ã—á–∏—Å–ª–µ–Ω–∏–µ gain:**\n",
        "   - –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ bins (–Ω–µ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è!)\n",
        "   - –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–µ —Å—É–º–º—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è $G_L, H_L, G_R, H_R$\n",
        "\n",
        "**–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞:**\n",
        "\n",
        "Split –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ bin $k$:\n",
        "- –õ–µ–≤–æ–µ –ø–æ–¥–¥–µ—Ä–µ–≤–æ: bins $0, 1, \\ldots, k$\n",
        "- –ü—Ä–∞–≤–æ–µ –ø–æ–¥–¥–µ—Ä–µ–≤–æ: bins $k+1, k+2, \\ldots, K$\n",
        "\n",
        "$$G_L = \\sum_{j=0}^{k} G_j, \\quad H_L = \\sum_{j=0}^{k} H_j$$\n",
        "\n",
        "$$G_R = G_{\\text{total}} - G_L, \\quad H_R = H_{\\text{total}} - H_L$$\n",
        "\n",
        "Gain (–∫–∞–∫ –≤ XGBoost):\n",
        "\n",
        "$$\\text{Gain} = \\frac{1}{2}\\left[\\frac{G_L^2}{H_L + \\lambda} + \\frac{G_R^2}{H_R + \\lambda} - \\frac{G_{\\text{total}}^2}{H_{\\text{total}} + \\lambda}\\right] - \\gamma$$\n",
        "\n",
        "**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**\n",
        "- ‚úÖ **–°–∫–æ—Ä–æ—Å—Ç—å:** $O(\\text{\\#features} \\times \\text{\\#bins})$ –≤–º–µ—Å—Ç–æ $O(\\text{\\#features} \\times \\text{\\#samples})$\n",
        "- ‚úÖ **–ü–∞–º—è—Ç—å:** –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã ($\\text{\\#bins}$ –æ–±—ã—á–Ω–æ 255), –∞ –Ω–µ –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è\n",
        "- ‚úÖ **Cache-friendly:** –ì–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã –∫–æ–º–ø–∞–∫—Ç–Ω—ã, –ø–æ–º–µ—â–∞—é—Ç—Å—è –≤ L3 cache\n",
        "\n",
        "**–ü–æ—Ç–µ—Ä—è —Ç–æ—á–Ω–æ—Å—Ç–∏?**\n",
        "- –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏: –¥–∞, —Ç.–∫. –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∏—Ä—É–µ–º\n",
        "- **–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏:** –ü–æ—Ç–µ—Ä–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã! –ß–∞—Å—Ç–æ –¥–∞–∂–µ **—É–ª—É—á—à–µ–Ω–∏–µ** –∏–∑-–∑–∞ —Ä–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü–∏–∏\n",
        "- 255 bins –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è capture –≤–∞–∂–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤\n",
        "\n",
        "---"
    ]
})

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "### 1.3 –ö–ª—é—á–µ–≤–∞—è –∏–Ω–Ω–æ–≤–∞—Ü–∏—è #2: Gradient-based One-Side Sampling (GOSS)\n",
        "\n",
        "#### –ú–æ—Ç–∏–≤–∞—Ü–∏—è\n",
        "\n",
        "**–ù–∞–±–ª—é–¥–µ–Ω–∏–µ:** –ù–µ –≤—Å–µ –ø—Ä–∏–º–µ—Ä—ã –æ–¥–∏–Ω–∞–∫–æ–≤–æ –≤–∞–∂–Ω—ã –¥–ª—è –æ–±—É—á–µ–Ω–∏—è!\n",
        "\n",
        "- –ü—Ä–∏–º–µ—Ä—ã —Å **–±–æ–ª—å—à–∏–º–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏** (–ø–ª–æ—Ö–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ) ‚Üí –≤–∞–∂–Ω—ã\n",
        "- –ü—Ä–∏–º–µ—Ä—ã —Å **–º–∞–ª—ã–º–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏** (—Ö–æ—Ä–æ—à–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ) ‚Üí –º–µ–Ω–µ–µ –≤–∞–∂–Ω—ã\n",
        "\n",
        "**–ò–¥–µ—è GOSS:** –°—ç–º–ø–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤!\n",
        "\n",
        "#### –ê–ª–≥–æ—Ä–∏—Ç–º GOSS\n",
        "\n",
        "**–®–∞–≥ 1: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º**\n",
        "\n",
        "–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ $i$ –≤—ã—á–∏—Å–ª—è–µ–º $|g_i|$ (–∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞).\n",
        "\n",
        "–°–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–∏–º–µ—Ä—ã: $|g_1| \\geq |g_2| \\geq \\ldots \\geq |g_n|$\n",
        "\n",
        "**–®–∞–≥ 2: Selective sampling**\n",
        "\n",
        "–ü—É—Å—Ç—å $a$ - –¥–æ–ª—è top –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤, $b$ - –¥–æ–ª—è random –∏–∑ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö.\n",
        "\n",
        "1. **–ë–µ—Ä–µ–º –í–°–ï –ø—Ä–∏–º–µ—Ä—ã** —Å —Ç–æ–ø-$a\\%$ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤ ‚Üí –º–Ω–æ–∂–µ—Å—Ç–≤–æ $A$\n",
        "   - $|A| = \\lfloor a \\cdot n \\rfloor$\n",
        "   - –≠—Ç–æ \"—Ç—Ä—É–¥–Ω—ã–µ\" –ø—Ä–∏–º–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–¥–µ–ª—å –ø–ª–æ—Ö–æ –ø—Ä–µ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç\n",
        "\n",
        "2. **–°–ª—É—á–∞–π–Ω–æ —Å—ç–º–ø–ª–∏—Ä—É–µ–º** $b\\%$ –∏–∑ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è ‚Üí –º–Ω–æ–∂–µ—Å—Ç–≤–æ $B$\n",
        "   - $|B| = \\lfloor b \\cdot n \\rfloor$\n",
        "   - –≠—Ç–æ representative sample \"–ª–µ–≥–∫–∏—Ö\" –ø—Ä–∏–º–µ—Ä–æ–≤\n",
        "\n",
        "3. **–ò—Ç–æ–≥–æ–≤—ã–π dataset:** $A \\cup B$ (—Ä–∞–∑–º–µ—Ä $(a+b) \\cdot n$)\n",
        "\n",
        "**–®–∞–≥ 3: –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –æ—Ü–µ–Ω–∫–∏**\n",
        "\n",
        "–ü—Ä–æ–±–ª–µ–º–∞: –í—ã–±—Ä–æ—Å–∏–ª–∏ $(1-a-b)\\cdot n$ –ø—Ä–∏–º–µ—Ä–æ–≤ —Å –º–∞–ª—ã–º–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏. –≠—Ç–æ –∏—Å–∫–∞–∂–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ!\n",
        "\n",
        "**–†–µ—à–µ–Ω–∏–µ:** –í–∑–≤–µ—à–∏–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã –∏–∑ $B$ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º $\\frac{1-a}{b}$\n",
        "\n",
        "–ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤ –¥–ª—è bin $k$:\n",
        "\n",
        "$$\\tilde{G}_k = \\sum_{i \\in A \\cap \\text{bin}_k} g_i + \\frac{1-a}{b} \\sum_{i \\in B \\cap \\text{bin}_k} g_i$$\n",
        "\n",
        "–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è $\\tilde{H}_k$.\n",
        "\n",
        "**–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**\n",
        "\n",
        "–ü—É—Å—Ç—å $\\mathbb{E}[g_i | i \\in \\text{–æ—Å—Ç–∞–ª—å–Ω—ã–µ}] = \\bar{g}_{small}$\n",
        "\n",
        "–¢–æ–≥–¥–∞ –æ–∂–∏–¥–∞–µ–º—ã–π –≤–∫–ª–∞–¥ –≤—Å–µ—Ö \"–º–∞–ª—ã—Ö\" –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤:\n",
        "\n",
        "$$\\mathbb{E}\\left[\\sum_{i \\in \\text{–æ—Å—Ç–∞–ª—å–Ω—ã–µ}} g_i\\right] = (1-a) \\cdot n \\cdot \\bar{g}_{small}$$\n",
        "\n",
        "–ú—ã —Å—ç–º–ø–ª–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ $b \\cdot n$ –∏–∑ –Ω–∏—Ö. –ß—Ç–æ–±—ã –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å:\n",
        "\n",
        "$$\\frac{(1-a) \\cdot n}{b \\cdot n} = \\frac{1-a}{b} \\quad \\text{(–≤–µ—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞ –∏–∑ } B)$$\n",
        "\n",
        "**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é):**\n",
        "- $a = 0.2$ (top 20% –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤)\n",
        "- $b = 0.1$ (10% random)\n",
        "- –ò—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ **30% –¥–∞–Ω–Ω—ã—Ö** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–µ—Ä–µ–≤–∞!\n",
        "\n",
        "**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**\n",
        "- ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ: –í 2-5 —Ä–∞–∑ (–º–µ–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏)\n",
        "- ‚úÖ –ö–∞—á–µ—Å—Ç–≤–æ: –°–æ–ø–æ—Å—Ç–∞–≤–∏–º–æ —Å full data (—Ñ–æ–∫—É—Å –Ω–∞ —Ç—Ä—É–¥–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞—Ö)\n",
        "- ‚úÖ –ü–∞–º—è—Ç—å: –ú–µ–Ω—å—à–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ\n",
        "\n",
        "**–û—Ç–ª–∏—á–∏–µ –æ—Ç –æ–±—ã—á–Ω–æ–≥–æ subsampling:**\n",
        "- –û–±—ã—á–Ω—ã–π subsample (XGBoost): **–°–ª—É—á–∞–π–Ω—ã–π** –≤—ã–±–æ—Ä –ø—Ä–∏–º–µ—Ä–æ–≤\n",
        "- GOSS: **–£–º–Ω—ã–π** –≤—ã–±–æ—Ä (keep —Ç—Ä—É–¥–Ω—ã–µ + sample –ª–µ–≥–∫–∏–µ)\n",
        "\n",
        "---"
    ]
})

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "### 1.4 –ö–ª—é—á–µ–≤–∞—è –∏–Ω–Ω–æ–≤–∞—Ü–∏—è #3: Exclusive Feature Bundling (EFB)\n",
        "\n",
        "#### –ú–æ—Ç–∏–≤–∞—Ü–∏—è\n",
        "\n",
        "**–ü—Ä–æ–±–ª–µ–º–∞:** –í —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –º–Ω–æ–≥–æ **—Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã—Ö (sparse) –ø—Ä–∏–∑–Ω–∞–∫–æ–≤**.\n",
        "\n",
        "–ü—Ä–∏–º–µ—Ä—ã:\n",
        "- One-hot encoded –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: –º–Ω–æ–≥–æ —Å—Ç–æ–ª–±—Ü–æ–≤, –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ = 0\n",
        "- Bag-of-words –¥–ª—è —Ç–µ–∫—Å—Ç–∞: –æ–≥—Ä–æ–º–Ω–∞—è —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç—å, –º–∞–ª–æ –Ω–µ–Ω—É–ª–µ–≤—ã—Ö\n",
        "- User-item interactions: sparse –º–∞—Ç—Ä–∏—Ü–∞\n",
        "\n",
        "**–ù–∞–±–ª—é–¥–µ–Ω–∏–µ:** –†–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ **—Ä–µ–¥–∫–æ –ø—Ä–∏–Ω–∏–º–∞—é—Ç –Ω–µ–Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ**!\n",
        "\n",
        "–ï—Å–ª–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏ $F_1$ –∏ $F_2$ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω–µ–Ω—É–ª–µ–≤—ã–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Üí –º–æ–∂–Ω–æ –∏—Ö **–æ–±—ä–µ–¥–∏–Ω–∏—Ç—å (bundle)**!\n",
        "\n",
        "#### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: Exclusive Features\n",
        "\n",
        "–ü—Ä–∏–∑–Ω–∞–∫–∏ $F_1$ –∏ $F_2$ –Ω–∞–∑—ã–≤–∞—é—Ç—Å—è **exclusive** (–≤–∑–∞–∏–º–æ–∏—Å–∫–ª—é—á–∞—é—â–∏–º–∏), –µ—Å–ª–∏:\n",
        "\n",
        "$$\\forall i: \\quad (F_1[i] \\neq 0) \\Rightarrow (F_2[i] = 0) \\quad \\text{–∏} \\quad (F_2[i] \\neq 0) \\Rightarrow (F_1[i] = 0)$$\n",
        "\n",
        "–ò–Ω–∞—á–µ –≥–æ–≤–æ—Ä—è, –æ–Ω–∏ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–Ω—É–ª–µ–≤—ã–º–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.\n",
        "\n",
        "**–ü—Ä–∏–º–µ—Ä:**\n",
        "- One-hot encoding –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: `is_male`, `is_female` - exclusive\n",
        "- Dummy variables –¥–ª—è weekday: `is_monday`, `is_tuesday`, ... - exclusive\n",
        "\n",
        "**–ò–¥–µ—è EFB:** –û–±—ä–µ–¥–∏–Ω–∏—Ç—å exclusive –ø—Ä–∏–∑–Ω–∞–∫–∏ –≤ –æ–¥–∏–Ω bundle!\n",
        "\n",
        "#### –ê–ª–≥–æ—Ä–∏—Ç–º EFB\n",
        "\n",
        "**–ó–∞–¥–∞—á–∞:** –ù–∞–π—Ç–∏ bundles –ø—Ä–∏–∑–Ω–∞–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å.\n",
        "\n",
        "–≠—Ç–æ **NP-hard** –ø—Ä–æ–±–ª–µ–º–∞ (graph coloring)! LightGBM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∂–∞–¥–Ω—ã–π —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º.\n",
        "\n",
        "**–®–∞–≥ 1: –ì—Ä–∞—Ñ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤**\n",
        "\n",
        "–°—Ç—Ä–æ–∏–º –≥—Ä–∞—Ñ $G = (V, E)$:\n",
        "- –í–µ—Ä—à–∏–Ω—ã $V$ = –ø—Ä–∏–∑–Ω–∞–∫–∏\n",
        "- –†–µ–±—Ä–æ $(F_i, F_j) \\in E$ –µ—Å–ª–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏ **–ù–ï** exclusive (–∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç)\n",
        "\n",
        "–í–µ—Å–∞ —Ä–µ–±–µ—Ä = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ (–ø—Ä–∏–º–µ—Ä–æ–≤ –≥–¥–µ –æ–±–∞ –Ω–µ–Ω—É–ª–µ–≤—ã–µ).\n",
        "\n",
        "**–®–∞–≥ 2: –ñ–∞–¥–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º bundling**\n",
        "\n",
        "```python\n",
        "def greedy_bundling(features, max_conflict=0):\n",
        "    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø–æ —Å—Ç–µ–ø–µ–Ω–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–Ω—É–ª–µ–≤—ã—Ö)\n",
        "    features = sorted(features, key=lambda f: f.count_nonzero(), reverse=True)\n",
        "    \n",
        "    bundles = []\n",
        "    \n",
        "    for feature in features:\n",
        "        # –ò—â–µ–º bundle —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏\n",
        "        best_bundle = None\n",
        "        min_conflict = infinity\n",
        "        \n",
        "        for bundle in bundles:\n",
        "            conflict = count_conflicts(feature, bundle)\n",
        "            if conflict < min_conflict:\n",
        "                min_conflict = conflict\n",
        "                best_bundle = bundle\n",
        "        \n",
        "        # –ï—Å–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –ø—Ä–∏–µ–º–ª–µ–º, –¥–æ–±–∞–≤–ª—è–µ–º –≤ bundle\n",
        "        if min_conflict <= max_conflict:\n",
        "            best_bundle.add(feature)\n",
        "        else:\n",
        "            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π bundle\n",
        "            bundles.append([feature])\n",
        "    \n",
        "    return bundles\n",
        "```\n",
        "\n",
        "**–®–∞–≥ 3: Merge –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –≤ bundle**\n",
        "\n",
        "–ö–∞–∫ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –≤ –æ–¥–∏–Ω?\n",
        "\n",
        "**–ü–æ–¥—Ö–æ–¥:** –î–æ–±–∞–≤–ª—è–µ–º **offsets** –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º —Ä–∞–∑–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤.\n",
        "\n",
        "–ü—É—Å—Ç—å bundle —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–∏–∑–Ω–∞–∫–∏ $F_1, F_2, \\ldots, F_k$ —Å –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º–∏ $[0, r_1], [0, r_2], \\ldots, [0, r_k]$.\n",
        "\n",
        "–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–∏–∑–Ω–∞–∫ $F_{\\text{bundle}}$:\n",
        "\n",
        "$$F_{\\text{bundle}}[i] = \\begin{cases}\n",
        "F_1[i] & \\text{–µ—Å–ª–∏ } F_1[i] \\neq 0 \\\\\n",
        "r_1 + F_2[i] & \\text{–µ—Å–ª–∏ } F_2[i] \\neq 0 \\\\\n",
        "r_1 + r_2 + F_3[i] & \\text{–µ—Å–ª–∏ } F_3[i] \\neq 0 \\\\\n",
        "\\vdots\n",
        "\\end{cases}$$\n",
        "\n",
        "**–ü—Ä–∏–º–µ—Ä:**\n",
        "- `is_male` ‚àà {0, 1}, `is_female` ‚àà {0, 1}\n",
        "- Bundle: `gender` = is_male + 2 * is_female ‚àà {0, 1, 2}\n",
        "  - 0 = missing\n",
        "  - 1 = male\n",
        "  - 2 = female\n",
        "\n",
        "**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** $O(\\text{\\#features}^2 \\times \\text{\\#samples})$ (–≥—Ä–∞—Ñ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)\n",
        "\n",
        "–ù–æ –¥–µ–ª–∞–µ—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑** –≤ –Ω–∞—á–∞–ª–µ!\n",
        "\n",
        "**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**\n",
        "- ‚úÖ –£–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–Ω–æ—Å—Ç–∏: 1000 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ ‚Üí 200-300 bundles\n",
        "- ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ: –ú–µ–Ω—å—à–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –¥–ª—è –ø–µ—Ä–µ–±–æ—Ä–∞\n",
        "- ‚úÖ –ü–∞–º—è—Ç—å: –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ\n",
        "\n",
        "**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**\n",
        "- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è **—Ä–∞–∑—Ä–µ–∂–µ–Ω–Ω—ã—Ö** –¥–∞–Ω–Ω—ã—Ö\n",
        "- –ï—Å–ª–∏ –ø—Ä–∏–∑–Ω–∞–∫–∏ –ø–ª–æ—Ç–Ω—ã–µ (dense), EFB –Ω–µ –¥–∞–µ—Ç –≤—ã–∏–≥—Ä—ã—à–∞\n",
        "\n",
        "---"
    ]
})

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "### 1.5 –ö–ª—é—á–µ–≤–∞—è –∏–Ω–Ω–æ–≤–∞—Ü–∏—è #4: Leaf-wise (Best-first) Tree Growth\n",
        "\n",
        "#### Level-wise vs Leaf-wise\n",
        "\n",
        "**XGBoost: Level-wise (depth-wise) growth**\n",
        "\n",
        "```\n",
        "–®–∞–≥ 1:        [Root]\n",
        "              /    \\\n",
        "–®–∞–≥ 2:      [A]    [B]\n",
        "            / \\    / \\\n",
        "–®–∞–≥ 3:    [C][D][E][F]\n",
        "```\n",
        "\n",
        "–†–∞–∑–±–∏–≤–∞–µ–º **–≤—Å–µ –ª–∏—Å—Ç—å—è –Ω–∞ —Ç–µ–∫—É—â–µ–º —É—Ä–æ–≤–Ω–µ**, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ splits –Ω–µ –æ—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω—ã.\n",
        "\n",
        "**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ level-wise:**\n",
        "- ‚úÖ –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ—Ä–µ–≤—å—è\n",
        "- ‚úÖ –ú–µ–Ω—å—à–µ overfitting (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥–ª—É–±–∏–Ω—ã)\n",
        "- ‚úÖ –ü—Ä–æ—â–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å\n",
        "\n",
        "**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**\n",
        "- ‚ùå –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ: —Ç—Ä–∞—Ç–∏–º splits –Ω–∞ –º–∞–ª–æ–ø–æ–ª–µ–∑–Ω—ã–µ —É–∑–ª—ã\n",
        "- ‚ùå –î–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –Ω—É–∂–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª—å—à–∞—è –≥–ª—É–±–∏–Ω–∞\n",
        "\n",
        "---\n",
        "\n",
        "**LightGBM: Leaf-wise (best-first) growth**\n",
        "\n",
        "```\n",
        "–®–∞–≥ 1:        [Root]\n",
        "              /    \\\n",
        "–®–∞–≥ 2:      [A]    [B]\n",
        "                   / \\\n",
        "–®–∞–≥ 3:           [C] [D]\n",
        "                     / \\\n",
        "–®–∞–≥ 4:             [E] [F]\n",
        "```\n",
        "\n",
        "–ù–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ —Ä–∞–∑–±–∏–≤–∞–µ–º **–ª–∏—Å—Ç —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º gain**, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —É—Ä–æ–≤–Ω—è!\n",
        "\n",
        "**–ê–ª–≥–æ—Ä–∏—Ç–º:**\n",
        "\n",
        "1. –ù–∞—á–∏–Ω–∞–µ–º —Å root\n",
        "2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ª–∏—Å—Ç–∞ –≤—ã—á–∏—Å–ª—è–µ–º **best possible split** –∏ –µ–≥–æ gain\n",
        "3. –í—ã–±–∏—Ä–∞–µ–º –ª–∏—Å—Ç —Å **–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º gain**\n",
        "4. –†–∞–∑–±–∏–≤–∞–µ–º —ç—Ç–æ—Ç –ª–∏—Å—Ç\n",
        "5. –ü–æ–≤—Ç–æ—Ä—è–µ–º –¥–æ `num_leaves` –ª–∏—Å—Ç—å–µ–≤\n",
        "\n",
        "**–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞:**\n",
        "\n",
        "–î–ª—è –ª–∏—Å—Ç–∞ $L$ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ $\\{i \\in L\\}$, best split –∏–º–µ–µ—Ç gain:\n",
        "\n",
        "$$\\text{Gain}_L = \\max_{\\text{feature, threshold}} \\left\\{ \\frac{1}{2}\\left[\\frac{G_L^2}{H_L + \\lambda} + \\frac{G_R^2}{H_R + \\lambda} - \\frac{G_{total}^2}{H_{total} + \\lambda}\\right] - \\gamma \\right\\}$$\n",
        "\n",
        "–í—ã–±–∏—Ä–∞–µ–º –ª–∏—Å—Ç:\n",
        "\n",
        "$$L^* = \\arg\\max_L \\text{Gain}_L$$\n",
        "\n",
        "**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ leaf-wise:**\n",
        "- ‚úÖ **–õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ:** –ö–∞–∂–¥—ã–π split –º–∞–∫—Å–∏–º–∏–∑–∏—Ä—É–µ—Ç gain\n",
        "- ‚úÖ **–ú–µ–Ω—å—à–µ –ª–∏—Å—Ç—å–µ–≤:** –î–ª—è —Ç–æ–≥–æ –∂–µ –∫–∞—á–µ—Å—Ç–≤–∞ –Ω—É–∂–Ω–æ –º–µ–Ω—å—à–µ splits\n",
        "- ‚úÖ **–ê—Å—Å–∏–º–µ—Ç—Ä–∏—á–Ω—ã–µ –¥–µ—Ä–µ–≤—å—è:** –ú–æ–≥—É—Ç –±—ã—Ç—å –≥–ª—É–±–æ–∫–∏–º–∏ –≤ –≤–∞–∂–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö, –º–µ–ª–∫–∏–º–∏ –≤ –Ω–µ–≤–∞–∂–Ω—ã—Ö\n",
        "\n",
        "**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**\n",
        "- ‚ùå **Overfitting:** Leaf-wise —Å–∫–ª–æ–Ω–µ–Ω –∫ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—é!\n",
        "- ‚ùå **–ù–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ—Ä–µ–≤—å—è:** –ì–ª—É–±–∏–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π\n",
        "\n",
        "**–†–µ—à–µ–Ω–∏–µ:** –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º `num_leaves` (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–∏—Å—Ç—å–µ–≤), –∞ –Ω–µ `max_depth`!\n",
        "\n",
        "**–ü—Ä–∞–≤–∏–ª–æ –±–æ–ª—å—à–æ–≥–æ –ø–∞–ª—å—Ü–∞:**\n",
        "\n",
        "$$\\text{num\\_leaves} < 2^{\\text{max\\_depth}}$$\n",
        "\n",
        "–û–±—ã—á–Ω–æ: `num_leaves` = 31 (—ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç `max_depth` = 5 –¥–ª—è balanced tree)\n",
        "\n",
        "**–≠–º–ø–∏—Ä–∏—á–µ—Å–∫–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**\n",
        "- Leaf-wise –Ω–∞ **20-30% —Ç–æ—á–Ω–µ–µ** –ø—Ä–∏ —Ç–æ–º –∂–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ª–∏—Å—Ç—å–µ–≤\n",
        "- –ù–æ —Ç—Ä–µ–±—É–µ—Ç **–∞–∫–∫—É—Ä–∞—Ç–Ω–æ–π** –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ regularization\n",
        "\n",
        "---"
    ]
})

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "### 1.6 –ö–ª—é—á–µ–≤–∞—è –∏–Ω–Ω–æ–≤–∞—Ü–∏—è #5: Native Categorical Feature Support\n",
        "\n",
        "#### –ü—Ä–æ–±–ª–µ–º–∞ —Å one-hot encoding\n",
        "\n",
        "**–¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥:** One-hot encoding –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤.\n",
        "\n",
        "–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å $K$ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ ‚Üí $K$ –±–∏–Ω–∞—Ä–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤.\n",
        "\n",
        "**–ü—Ä–æ–±–ª–µ–º—ã:**\n",
        "1. **High cardinality:** –ï—Å–ª–∏ $K = 1000$ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–æ—Ä–æ–¥), –ø–æ–ª—É—á–∞–µ–º 1000 –ø—Ä–∏–∑–Ω–∞–∫–æ–≤!\n",
        "2. **–†–∞–∑—Ä–µ–∂–µ–Ω–Ω–æ—Å—Ç—å:** –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –∑–Ω–∞—á–µ–Ω–∏–π = 0\n",
        "3. **–ü–æ—Ç–µ—Ä—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:** –ù–µ —É—á–∏—Ç—ã–≤–∞–µ–º –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∏ –º–µ–∂–¥—É –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏\n",
        "4. **–ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ splits:** –î–µ—Ä–µ–≤–æ –º–æ–∂–µ—Ç —Ä–∞–∑–±–∏–≤–∞—Ç—å –ø–æ –æ–¥–Ω–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é –∑–∞ —Ä–∞–∑\n",
        "\n",
        "#### LightGBM: Optimal Split –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π\n",
        "\n",
        "**–ò–¥–µ—è:** –ù–∞–π—Ç–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–∞ –¥–≤–∞ –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–∞.\n",
        "\n",
        "**–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á–∏:**\n",
        "\n",
        "–ü—É—Å—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∞–ª—å–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫ –∏–º–µ–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è $\\{c_1, c_2, \\ldots, c_K\\}$.\n",
        "\n",
        "–•–æ—Ç–∏–º –Ω–∞–π—Ç–∏ split: $S \\subset \\{c_1, \\ldots, c_K\\}$ vs $\\{c_1, \\ldots, c_K\\} \\setminus S$\n",
        "\n",
        "–ú–∞–∫—Å–∏–º–∏–∑–∏—Ä—É–µ–º gain:\n",
        "\n",
        "$$\\text{Gain}(S) = \\frac{1}{2}\\left[\\frac{G_L^2}{H_L + \\lambda} + \\frac{G_R^2}{H_R + \\lambda} - \\frac{G_{total}^2}{H_{total} + \\lambda}\\right] - \\gamma$$\n",
        "\n",
        "–≥–¥–µ $G_L = \\sum_{i: x_i \\in S} g_i$, $H_L = \\sum_{i: x_i \\in S} h_i$\n",
        "\n",
        "**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** $2^K$ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤ - –ø–µ—Ä–µ–±–æ—Ä –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω!\n",
        "\n",
        "#### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è regression (Fisher, 1958)\n",
        "\n",
        "**–¢–µ–æ—Ä–µ–º–∞:** –î–ª—è squared loss –∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö hessian (regression), –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π split –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É target!\n",
        "\n",
        "**–ê–ª–≥–æ—Ä–∏—Ç–º:**\n",
        "\n",
        "1. –î–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ $c_k$ –≤—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ:\n",
        "   $$\\bar{y}_k = \\frac{\\sum_{i: x_i = c_k} y_i}{\\sum_{i: x_i = c_k} 1}$$\n",
        "\n",
        "2. –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: $\\bar{y}_{k_1} \\leq \\bar{y}_{k_2} \\leq \\ldots \\leq \\bar{y}_{k_K}$\n",
        "\n",
        "3. –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º $K-1$ split:\n",
        "   - $S_j = \\{c_{k_1}, \\ldots, c_{k_j}\\}$ vs –æ—Å—Ç–∞–ª—å–Ω—ã–µ\n",
        "   - –í—ã—á–∏—Å–ª—è–µ–º gain\n",
        "\n",
        "4. –í—ã–±–∏—Ä–∞–µ–º best split\n",
        "\n",
        "**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** $O(K \\log K)$ (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞) + $O(K)$ (–ø–æ–∏—Å–∫ split) = $O(K \\log K)$\n",
        "\n",
        "–í–º–µ—Å—Ç–æ $O(2^K)$!\n",
        "\n",
        "#### –û–±–æ–±—â–µ–Ω–∏–µ –¥–ª—è classification\n",
        "\n",
        "–î–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ hessian –Ω–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ, –ø–æ—ç—Ç–æ–º—É —Ç–æ—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.\n",
        "\n",
        "**Heuristic:** –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ $\\frac{G_k}{H_k + \\lambda}$ (–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –≥—Ä–∞–¥–∏–µ–Ω—Ç/hessian).\n",
        "\n",
        "–≠—Ç–æ –∞–ø–ø—Ä–æ–∫—Å–∏–º–∏—Ä—É–µ—Ç \"–≤–∞–∂–Ω–æ—Å—Ç—å\" –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è split.\n",
        "\n",
        "**–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**\n",
        "\n",
        "–ï—Å–ª–∏ $K$ –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–µ (>100), –¥–∞–∂–µ $O(K \\log K)$ –¥–æ—Ä–æ–≥–æ.\n",
        "\n",
        "**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ–º **histogram** –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π!\n",
        "- –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ä–µ–¥–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ \"other\" bin\n",
        "- –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º max –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ bins (–ø–∞—Ä–∞–º–µ—Ç—Ä `max_cat_threshold`)\n",
        "\n",
        "**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**\n",
        "- ‚úÖ –ù–µ –Ω—É–∂–µ–Ω one-hot encoding\n",
        "- ‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ splits (vs –∂–∞–¥–Ω—ã–π one-at-a-time)\n",
        "- ‚úÖ –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –¥–µ—Ä–µ–≤—å—è\n",
        "\n",
        "**–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**\n",
        "```python\n",
        "lgb.Dataset(X, y, categorical_feature=['city', 'country', 'product'])\n",
        "```\n",
        "\n",
        "---"
    ]
})

# –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —è—á–µ–π–∫–∏ —Ç–µ–æ—Ä–∏–∏
notebook['cells'] = cells

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–∑–æ–≤—ã–π –Ω–æ—É—Ç–±—É–∫ —Å —Ç–µ–æ—Ä–∏–µ–π
output_path = '02_lightgbm_deep_dive.ipynb'
with open(output_path, 'w', encoding='utf-8') as f:
    json.dump(notebook, f, ensure_ascii=False, indent=1)

print(f'‚úÖ –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∞—è —á–∞—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∞: {len(cells)} —è—á–µ–µ–∫')
print(f'–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {output_path}')
