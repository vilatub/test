#!/bin/bash

# Pre-commit hook to normalize line endings in Jupyter notebooks
# Converts CRLF to LF for .ipynb files

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get list of staged .ipynb files
IPYNB_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.ipynb$')

if [ -z "$IPYNB_FILES" ]; then
    # No .ipynb files staged, exit successfully
    exit 0
fi

echo -e "${YELLOW}Checking Jupyter notebooks for line ending issues...${NC}"

FIXED_FILES=0
for file in $IPYNB_FILES; do
    if [ -f "$file" ]; then
        # Check if file has CRLF line endings
        if file "$file" | grep -q CRLF; then
            echo -e "${YELLOW}  Fixing CRLF → LF: $file${NC}"

            # Convert CRLF to LF (works on Linux, Mac, and Windows Git Bash)
            python3 << EOF
with open('$file', 'rb') as f:
    content = f.read()
# Replace CRLF with LF
content = content.replace(b'\r\n', b'\n')
with open('$file', 'wb') as f:
    f.write(content)
EOF

            # Re-stage the file
            git add "$file"
            FIXED_FILES=$((FIXED_FILES + 1))
        fi
    fi
done

if [ $FIXED_FILES -gt 0 ]; then
    echo -e "${GREEN}✓ Fixed line endings in $FIXED_FILES file(s)${NC}"
    echo -e "${GREEN}  Files have been re-staged with LF line endings${NC}"
fi

exit 0
