#!/usr/bin/env python3
"""
–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –Ω–æ—É—Ç–±—É–∫–∞: RNN/LSTM/GRU –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤
Phase 3, Step 2: Deep Learning –Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö
"""

import json

# –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –Ω–æ—É—Ç–±—É–∫–∞
notebook = {
    "cells": [],
    "metadata": {
        "kernelspec": {
            "display_name": "Python 3",
            "language": "python",
            "name": "python3"
        },
        "language_info": {
            "name": "python",
            "version": "3.8.0"
        }
    },
    "nbformat": 4,
    "nbformat_minor": 4
}

cells = []

# ============================================================================
# TITLE AND INTRODUCTION
# ============================================================================

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "# üß† RNN/LSTM/GRU –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤\n",
        "\n",
        "**Phase 3: Temporal Data & RNN - Step 2**\n",
        "\n",
        "---\n",
        "\n",
        "## üéØ –¶–µ–ª–∏ –Ω–æ—É—Ç–±—É–∫–∞\n",
        "\n",
        "1. **–ü–æ–Ω—è—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã RNN:** Vanilla RNN, LSTM, GRU\n",
        "2. **–ü—Ä–æ–±–ª–µ–º—ã RNN:** vanishing/exploding gradients\n",
        "3. **–ü—Ä–∞–∫—Ç–∏–∫–∞ –Ω–∞ PyTorch:** —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è\n",
        "4. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∫–ª–∞—Å—Å–∏–∫–æ–π:** RNN vs ARIMA/SARIMA\n",
        "5. **–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏:** Bidirectional, Stacked RNN\n",
        "\n",
        "---\n",
        "\n",
        "## üìä –î–∞—Ç–∞—Å–µ—Ç: Airline Passengers\n",
        "\n",
        "**–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –¥–∞—Ç–∞—Å–µ—Ç** –¥–ª—è —á–µ—Å—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å ARIMA/SARIMA/Prophet.\n",
        "\n",
        "**–ó–∞—á–µ–º Deep Learning?**\n",
        "- üìà **–ù–µ–ª–∏–Ω–µ–π–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:** RNN –º–æ–≥—É—Ç –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏\n",
        "- üîó **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å:** LSTM –¥–ª—è long-term dependencies\n",
        "- üß† **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–∏:** –Ω–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —Å–æ–∑–¥–∞–≤–∞—Ç—å –ª–∞–≥–∏\n",
        "- üéØ **Multivariate –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:** –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏\n",
        "\n",
        "**–ß–µ—Å—Ç–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:**\n",
        "- ‚ùå **RNN –ù–ï –≤—Å–µ–≥–¥–∞ –ª—É—á—à–µ** –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è univariate TS\n",
        "- ‚ùå **–¢—Ä–µ–±—É—é—Ç –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö** (–Ω–∞—à –¥–∞—Ç–∞—Å–µ—Ç –º–∞–ª–µ–Ω—å–∫–∏–π - 144 —Ç–æ—á–∫–∏)\n",
        "- ‚ùå **–î–æ–ª—å—à–µ –æ–±—É—á–∞—é—Ç—Å—è** –∏ —Å–ª–æ–∂–Ω–µ–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å\n",
        "- ‚úÖ **–¶–µ–ª—å:** –ø–æ–Ω—è—Ç—å –æ—Å–Ω–æ–≤—ã –¥–ª—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á\n",
        "\n",
        "---"
    ]
})

# ============================================================================
# THEORY PART 1: VANILLA RNN
# ============================================================================

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "## üìö –ß–∞—Å—Ç—å 1: –¢–µ–æ—Ä–∏—è —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö —Å–µ—Ç–µ–π\n",
        "\n",
        "### 1.1 Vanilla RNN (–ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω–∞—è —Å–µ—Ç—å)\n",
        "\n",
        "**–ò–¥–µ—è:** –ù–∞ –∫–∞–∂–¥–æ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–º —à–∞–≥–µ —Å–µ—Ç—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥ $x_t$ –∏ —Å–∫—Ä—ã—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ $h_{t-1}$.\n",
        "\n",
        "#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞\n",
        "\n",
        "**Forward pass:**\n",
        "\n",
        "$$h_t = \\tanh(W_{hh} h_{t-1} + W_{xh} x_t + b_h)$$\n",
        "\n",
        "$$y_t = W_{hy} h_t + b_y$$\n",
        "\n",
        "–≥–¥–µ:\n",
        "- $x_t$ ‚Äî –≤—Ö–æ–¥ –Ω–∞ —à–∞–≥–µ $t$ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤)\n",
        "- $h_t$ ‚Äî —Å–∫—Ä—ã—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (hidden state) –Ω–∞ —à–∞–≥–µ $t$\n",
        "- $h_{t-1}$ ‚Äî —Å–∫—Ä—ã—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞\n",
        "- $W_{xh}$ ‚Äî –≤–µ—Å–∞ –¥–ª—è –≤—Ö–æ–¥–∞\n",
        "- $W_{hh}$ ‚Äî –≤–µ—Å–∞ –¥–ª—è —Å–∫—Ä—ã—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è (—Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ)\n",
        "- $W_{hy}$ ‚Äî –≤–µ—Å–∞ –¥–ª—è –≤—ã—Ö–æ–¥–∞\n",
        "- $\\tanh$ ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏\n",
        "\n",
        "**–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏):**\n",
        "\n",
        "```\n",
        "x‚ÇÅ  ‚Üí  [RNN]  ‚Üí  h‚ÇÅ  ‚Üí  y‚ÇÅ\n",
        "         ‚Üì\n",
        "x‚ÇÇ  ‚Üí  [RNN]  ‚Üí  h‚ÇÇ  ‚Üí  y‚ÇÇ\n",
        "         ‚Üì\n",
        "x‚ÇÉ  ‚Üí  [RNN]  ‚Üí  h‚ÇÉ  ‚Üí  y‚ÇÉ\n",
        "         ‚Üì\n",
        "       ...\n",
        "```\n",
        "\n",
        "---\n",
        "\n",
        "### 1.2 –ü—Ä–æ–±–ª–µ–º–∞ Vanishing Gradient\n",
        "\n",
        "**Backpropagation Through Time (BPTT):**\n",
        "\n",
        "–ü—Ä–∏ –æ–±—Ä–∞—Ç–Ω–æ–º —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —à–∞–≥–æ–≤:\n",
        "\n",
        "$$\\frac{\\partial L}{\\partial h_1} = \\frac{\\partial L}{\\partial h_T} \\prod_{t=2}^{T} \\frac{\\partial h_t}{\\partial h_{t-1}}$$\n",
        "\n",
        "–ì—Ä–∞–¥–∏–µ–Ω—Ç:\n",
        "\n",
        "$$\\frac{\\partial h_t}{\\partial h_{t-1}} = W_{hh}^T \\cdot \\text{diag}(1 - \\tanh^2(z_t))$$\n",
        "\n",
        "**–ü—Ä–æ–±–ª–µ–º–∞:**\n",
        "- –ï—Å–ª–∏ $\\|W_{hh}\\| < 1$ ‚Üí –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã **–∏—Å—á–µ–∑–∞—é—Ç** (vanishing)\n",
        "- –ï—Å–ª–∏ $\\|W_{hh}\\| > 1$ ‚Üí –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã **–≤–∑—Ä—ã–≤–∞—é—Ç—Å—è** (exploding)\n",
        "\n",
        "**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Vanilla RNN **–ø–ª–æ—Ö–æ –æ–±—É—á–∞–µ—Ç—Å—è** –Ω–∞ –¥–ª–∏–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è—Ö (> 10-20 —à–∞–≥–æ–≤).\n",
        "\n",
        "**–†–µ—à–µ–Ω–∏–µ:** LSTM –∏ GRU!\n",
        "\n",
        "---"
    ]
})

# ============================================================================
# THEORY PART 2: LSTM
# ============================================================================

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "### 1.3 LSTM (Long Short-Term Memory)\n",
        "\n",
        "**LSTM —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É vanishing gradient** —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º **gates** (–≤–æ—Ä–æ—Ç).\n",
        "\n",
        "#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ LSTM\n",
        "\n",
        "LSTM –∏–º–µ–µ—Ç **–¥–≤–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**\n",
        "- $c_t$ ‚Äî **cell state** (–¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å)\n",
        "- $h_t$ ‚Äî **hidden state** (–∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–∞—è –ø–∞–º—è—Ç—å)\n",
        "\n",
        "**–¢—Ä–∏ gates:**\n",
        "\n",
        "**1. Forget Gate** (—á—Ç–æ –∑–∞–±—ã—Ç—å –∏–∑ cell state):\n",
        "\n",
        "$$f_t = \\sigma(W_f [h_{t-1}, x_t] + b_f)$$\n",
        "\n",
        "**2. Input Gate** (—á—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ cell state):\n",
        "\n",
        "$$i_t = \\sigma(W_i [h_{t-1}, x_t] + b_i)$$\n",
        "\n",
        "$$\\tilde{c}_t = \\tanh(W_c [h_{t-1}, x_t] + b_c)$$\n",
        "\n",
        "**3. Output Gate** (—á—Ç–æ –≤—ã–≤–µ—Å—Ç–∏):\n",
        "\n",
        "$$o_t = \\sigma(W_o [h_{t-1}, x_t] + b_o)$$\n",
        "\n",
        "---\n",
        "\n",
        "**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π:**\n",
        "\n",
        "$$c_t = f_t \\odot c_{t-1} + i_t \\odot \\tilde{c}_t$$\n",
        "\n",
        "$$h_t = o_t \\odot \\tanh(c_t)$$\n",
        "\n",
        "–≥–¥–µ:\n",
        "- $\\sigma$ ‚Äî sigmoid (–≤—ã—Ö–æ–¥ 0-1, —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ gate)\n",
        "- $\\odot$ ‚Äî element-wise —É–º–Ω–æ–∂–µ–Ω–∏–µ\n",
        "- $[h_{t-1}, x_t]$ ‚Äî –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è\n",
        "\n",
        "---\n",
        "\n",
        "**–ò–Ω—Ç—É–∏—Ü–∏—è:**\n",
        "- **Forget gate:** \"–°–∫–æ–ª—å–∫–æ –∑–∞–±—ã—Ç—å –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ?\"\n",
        "- **Input gate:** \"–°–∫–æ–ª—å–∫–æ –Ω–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–æ–±–∞–≤–∏—Ç—å?\"\n",
        "- **Output gate:** \"–ß—Ç–æ –≤—ã–≤–µ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞–º—è—Ç–∏?\"\n",
        "\n",
        "**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** Cell state $c_t$ —Ç–µ—á–µ—Ç —á–µ—Ä–µ–∑ –≤—Å—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ ‚Üí **–Ω–µ—Ç vanishing gradient**!\n",
        "\n",
        "---"
    ]
})

# ============================================================================
# THEORY PART 3: GRU
# ============================================================================

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "### 1.4 GRU (Gated Recurrent Unit)\n",
        "\n",
        "**GRU** ‚Äî —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è LSTM —Å **–º–µ–Ω—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤**.\n",
        "\n",
        "#### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ GRU\n",
        "\n",
        "**–î–≤–∞ gates:**\n",
        "\n",
        "**1. Reset Gate** (—Å–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ—à–ª—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é):\n",
        "\n",
        "$$r_t = \\sigma(W_r [h_{t-1}, x_t] + b_r)$$\n",
        "\n",
        "**2. Update Gate** (–æ–±–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ):\n",
        "\n",
        "$$z_t = \\sigma(W_z [h_{t-1}, x_t] + b_z)$$\n",
        "\n",
        "**–ö–∞–Ω–¥–∏–¥–∞—Ç –Ω–∞ –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**\n",
        "\n",
        "$$\\tilde{h}_t = \\tanh(W_h [r_t \\odot h_{t-1}, x_t] + b_h)$$\n",
        "\n",
        "**–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**\n",
        "\n",
        "$$h_t = (1 - z_t) \\odot h_{t-1} + z_t \\odot \\tilde{h}_t$$\n",
        "\n",
        "---\n",
        "\n",
        "**–û—Ç–ª–∏—á–∏—è –æ—Ç LSTM:**\n",
        "- ‚úÖ **–ú–µ–Ω—å—à–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤** (2 gates vs 3)\n",
        "- ‚úÖ **–ë—ã—Å—Ç—Ä–µ–µ –æ–±—É—á–∞–µ—Ç—Å—è**\n",
        "- ‚úÖ **–û–¥–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ** ($h_t$ –≤–º–µ—Å—Ç–æ $h_t$ –∏ $c_t$)\n",
        "- ‚ö†Ô∏è **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –æ–±—ã—á–Ω–æ —Å–æ–ø–æ—Å—Ç–∞–≤–∏–º–∞ —Å LSTM, –∏–Ω–æ–≥–¥–∞ —á—É—Ç—å —Ö—É–∂–µ\n",
        "\n",
        "---\n",
        "\n",
        "### 1.5 –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: RNN vs LSTM vs GRU\n",
        "\n",
        "| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | Vanilla RNN | LSTM | GRU |\n",
        "|----------------|-------------|------|-----|\n",
        "| **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã** | –ú–∞–ª–æ | –ú–Ω–æ–≥–æ (4x) | –°—Ä–µ–¥–Ω–µ (3x) |\n",
        "| **–°–∫–æ—Ä–æ—Å—Ç—å** | –ë—ã—Å—Ç—Ä–æ | –ú–µ–¥–ª–µ–Ω–Ω–æ | –°—Ä–µ–¥–Ω–µ |\n",
        "| **Long-term dependencies** | ‚ùå –ü–ª–æ—Ö–æ | ‚úÖ –û—Ç–ª–∏—á–Ω–æ | ‚úÖ –•–æ—Ä–æ—à–æ |\n",
        "| **Vanishing gradient** | ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ | ‚úÖ –†–µ—à–µ–Ω–∞ | ‚úÖ –†–µ—à–µ–Ω–∞ |\n",
        "| **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å** | –ö–æ—Ä–æ—Ç–∫–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (< 10) | –î–ª–∏–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –Ω—É–∂–Ω–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å | –ë–∞–ª–∞–Ω—Å —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —Ç–æ—á–Ω–æ—Å—Ç–∏ |\n",
        "\n",
        "**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**\n",
        "- –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å **GRU** (–±—ã—Å—Ç—Ä–µ–µ, –ø—Ä–æ—â–µ)\n",
        "- –ï—Å–ª–∏ GRU –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è ‚Üí **LSTM**\n",
        "- Vanilla RNN ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è\n",
        "\n",
        "---"
    ]
})

# ============================================================================
# THEORY PART 4: ADVANCED TECHNIQUES
# ============================================================================

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "### 1.6 –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ç–µ—Ö–Ω–∏–∫–∏\n",
        "\n",
        "#### Bidirectional RNN\n",
        "\n",
        "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å **–≤ –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã:**\n",
        "\n",
        "$$\\vec{h}_t = \\text{RNN}(x_1, x_2, ..., x_t)$$\n",
        "\n",
        "$$\\overleftarrow{h}_t = \\text{RNN}(x_T, x_{T-1}, ..., x_t)$$\n",
        "\n",
        "$$h_t = [\\vec{h}_t; \\overleftarrow{h}_t]$$\n",
        "\n",
        "**–ö–æ–≥–¥–∞ –ø–æ–ª–µ–∑–Ω–æ:**\n",
        "- ‚úÖ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π (–≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ—Å—Ç—É–ø–µ–Ω)\n",
        "- ‚ùå –ù–ï –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–µ–ª—å–∑—è –∑–Ω–∞—Ç—å –±—É–¥—É—â–µ–µ!)\n",
        "\n",
        "---\n",
        "\n",
        "#### Stacked (Multi-layer) RNN\n",
        "\n",
        "–ù–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–µ–≤ RNN –¥—Ä—É–≥ –Ω–∞–¥ –¥—Ä—É–≥–æ–º:\n",
        "\n",
        "```\n",
        "x ‚Üí [LSTM‚ÇÅ] ‚Üí h‚ÇÅ ‚Üí [LSTM‚ÇÇ] ‚Üí h‚ÇÇ ‚Üí [LSTM‚ÇÉ] ‚Üí h‚ÇÉ ‚Üí y\n",
        "```\n",
        "\n",
        "**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**\n",
        "- ‚úÖ –ë–æ–ª–µ–µ –≥–ª—É–±–æ–∫–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è –ø—Ä–∏–∑–Ω–∞–∫–æ–≤\n",
        "- ‚úÖ –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö\n",
        "\n",
        "**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**\n",
        "- ‚ùå –ë–æ–ª—å—à–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ‚Üí –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ –Ω–∞ –º–∞–ª—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n",
        "- ‚ùå –î–æ–ª—å—à–µ –æ–±—É—á–∞–µ—Ç—Å—è\n",
        "\n",
        "**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** 1-2 —Å–ª–æ—è –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.\n",
        "\n",
        "---\n",
        "\n",
        "#### Teacher Forcing\n",
        "\n",
        "**–ü—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏:** –∏—Å–ø–æ–ª—å–∑—É–µ–º **–∏—Å—Ç–∏–Ω–Ω—ã–µ** –∑–Ω–∞—á–µ–Ω–∏—è $y_{t-1}$ –∫–∞–∫ –≤—Ö–æ–¥ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è $y_t$  \n",
        "**–ü—Ä–∏ inference:** –∏—Å–ø–æ–ª—å–∑—É–µ–º **–ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ** –∑–Ω–∞—á–µ–Ω–∏—è $\\hat{y}_{t-1}$\n",
        "\n",
        "**–ü—Ä–æ–±–ª–µ–º–∞:** model mismatch (train vs test)  \n",
        "**–†–µ—à–µ–Ω–∏–µ:** Scheduled sampling (–ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)\n",
        "\n",
        "---"
    ]
})

# ============================================================================
# PRACTICAL PART: IMPORTS
# ============================================================================

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "## üíª –ß–∞—Å—Ç—å 2: –ü—Ä–∞–∫—Ç–∏–∫–∞ - RNN –Ω–∞ PyTorch\n",
        "\n",
        "### 2.1 –ò–º–ø–æ—Ä—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫"
    ]
})

cells.append({
    "cell_type": "code",
    "execution_count": None,
    "metadata": {},
    "outputs": [],
    "source": [
        "# –ë–∞–∑–æ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏\n",
        "import numpy as np\n",
        "import pandas as pd\n",
        "import matplotlib.pyplot as plt\n",
        "import seaborn as sns\n",
        "import warnings\n",
        "warnings.filterwarnings('ignore')\n",
        "\n",
        "# PyTorch\n",
        "import torch\n",
        "import torch.nn as nn\n",
        "import torch.optim as optim\n",
        "from torch.utils.data import Dataset, DataLoader, TensorDataset\n",
        "\n",
        "# Sklearn\n",
        "from sklearn.preprocessing import MinMaxScaler\n",
        "from sklearn.metrics import mean_squared_error, mean_absolute_error\n",
        "\n",
        "# –î–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Å—Ä–∞–≤–Ω–∏—Ç—å)\n",
        "from statsmodels.tsa.statespace.sarimax import SARIMAX\n",
        "\n",
        "# –ù–∞—Å—Ç—Ä–æ–π–∫–∏\n",
        "plt.style.use('seaborn-v0_8-darkgrid')\n",
        "sns.set_palette(\"husl\")\n",
        "%matplotlib inline\n",
        "\n",
        "# Device\n",
        "device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')\n",
        "print(f\"Device: {device}\")\n",
        "\n",
        "# Reproducibility\n",
        "torch.manual_seed(42)\n",
        "np.random.seed(42)\n",
        "\n",
        "print(\"‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã\")"
    ]
})

# ============================================================================
# LOAD DATA
# ============================================================================

cells.append({
    "cell_type": "markdown",
    "metadata": {},
    "source": [
        "### 2.2 –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö\n",
        "\n",
        "–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ Airline Passengers –¥–∞—Ç–∞—Å–µ—Ç."
    ]
})

cells.append({
    "cell_type": "code",
    "execution_count": None,
    "metadata": {},
    "outputs": [],
    "source": [
        "# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞\n",
        "try:\n",
        "    from statsmodels.datasets import get_rdataset\n",
        "    airline_data = get_rdataset('AirPassengers', 'datasets')\n",
        "    df = airline_data.data\n",
        "    df.columns = ['time', 'passengers']\n",
        "except:\n",
        "    url = 'https://raw.githubusercontent.com/jbrownlee/Datasets/master/airline-passengers.csv'\n",
        "    df = pd.read_csv(url, parse_dates=['Month'], index_col='Month')\n",
        "    df.columns = ['passengers']\n",
        "    df.reset_index(inplace=True)\n",
        "    df.columns = ['time', 'passengers']\n",
        "\n",
        "df['time'] = pd.to_datetime(df['time'])\n",
        "df.set_index('time', inplace=True)\n",
        "\n",
        "print(f\"–î–∞—Ç–∞—Å–µ—Ç: {df.shape[0]} –Ω–∞–±–ª—é–¥–µ–Ω–∏–π\")\n",
        "print(f\"–ü–µ—Ä–∏–æ–¥: {df.index.min()} - {df.index.max()}\")\n",
        "\n",
        "# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è\n",
        "plt.figure(figsize=(14, 5))\n",
        "plt.plot(df.index, df['passengers'], linewidth=2)\n",
        "plt.title('Airline Passengers (1949-1960)', fontsize=16, fontweight='bold')\n",
        "plt.xlabel('Time')\n",
        "plt.ylabel('Passengers')\n",
        "plt.grid(alpha=0.3)\n",
        "plt.tight_layout()\n",
        "plt.show()\n",
        "\n",
        "df.head()"
    ]
})

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å
notebook['cells'] = cells

output_path = '/home/user/test/notebooks/phase3_temporal_rnn/02_rnn_lstm_gru.ipynb'
with open(output_path, 'w', encoding='utf-8') as f:
    json.dump(notebook, f, ensure_ascii=False, indent=1)

print(f'‚úÖ –ß–∞—Å—Ç—å 1 —Å–æ–∑–¥–∞–Ω–∞ (—Ç–µ–æ—Ä–∏—è + –Ω–∞—á–∞–ª–æ): {output_path}')
print(f'–Ø—á–µ–µ–∫: {len(cells)}')
print('–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è RNN, –º–æ–¥–µ–ª–∏...')
